<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 100%; }
    </style>
  </head>
  <body>
      <div >
       <a href = "{% url 'profile:signup' %}"> Register Here </a> 

      </div>

    <div id="map"></div>
    <script type="text/javascript">

var map;
var delay = 0;
var i = 0;
var geocoder;
var json_test;
var addresses = {{ geocode_locations|safe }};

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 49.2561055, lng: -123.1939531},
    zoom: 11
  });
  geocoder = new google.maps.Geocoder();
  
  {% for location in init_locations %}
      createMarker(new google.maps.LatLng({{ location.latitude }}, {{ location.longitude }}));
  {% endfor %}

  {% if geocode_locations %}
    plotLocations(addresses);
  {% endif %}
  }

// used code from http://stackoverflow.com/questions/19640055/multiple-markers-google-map-api-v3-from-array-of-addresses-and-avoid-over-query
function geocodeAddress(address, next) {
  geocoder.geocode({ 'address': address, 'bounds': map.getBounds() }, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      delay = 0;
      createMarker(results[0].geometry.location)
    } else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
      i--;
      delay = 60;
    } else {
      console.log('Geocode not successful for the following reason: ' + status);
    }
    next();
  });
}

function createMarker(latLng) {
  var marker = new google.maps.Marker({
    map: map,
    position: latLng
  })
}

function plotLocations() {
  if (i < addresses.length) {
    setTimeout('geocodeAddress("'+ addresses[i].fields.address + ', ' + addresses[i].fields.city +'", plotLocations)', delay);
    i++;
  }
}


    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDw3QjnTZGH6JIV9NyKnrXsxo6acAKITJY&callback=initMap">
    </script>
  </body>
</html>
